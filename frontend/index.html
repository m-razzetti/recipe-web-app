<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipes</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Library</h2>

    <h3>Paste Markdown</h3>
    <input id="recipe-name" placeholder="Recipe name" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>

    <input type="file" id="photo-input" />
    <button onclick="saveRecipe()">Save Recipe</button>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">

    <!-- GRID VIEW -->
    <div id="grid-view">
      <div id="recipe-grid" class="grid"></div>
    </div>

    <!-- RECIPE VIEW -->
    <div id="recipe-view" style="display:none">
      <div style="display:flex; gap:8px; margin-bottom:12px">
        <button onclick="showGrid()">‚Üê Back</button>
        <button onclick="editCurrentRecipe()">Edit</button>
      </div>

      <div id="recipe-content" class="recipe"></div>
    </div>

  </main>

</div>

<script>
const API = "http://192.168.1.3:9001/api";
let currentRecipe = null;

/* ---------- View helpers ---------- */

function showGrid() {
  document.getElementById("recipe-view").style.display = "none";
  document.getElementById("grid-view").style.display = "block";
  currentRecipe = null;
}

function showRecipe() {
  document.getElementById("grid-view").style.display = "none";
  document.getElementById("recipe-view").style.display = "block";
}

/* ---------- Load recipe cards ---------- */

async function loadRecipes() {
  const res = await fetch(`${API}/recipes`);
  const recipes = await res.json();

  const grid = document.getElementById("recipe-grid");
  grid.innerHTML = "";

  for (const name of recipes) {
    const card = document.createElement("div");
    card.className = "card";

    const image = document.createElement("div");
    image.className = "card-image";

    const mdRes = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
    const md = await mdRes.text();
    const match = md.match(/!\[[^\]]*]\(([^)]+)\)/);

    if (match) {
      const filename = match[1];
      image.style.backgroundImage =
        `url('${API}/photos/${encodeURIComponent(name)}/${encodeURIComponent(filename)}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = name;

    card.appendChild(image);
    card.appendChild(title);

    card.onclick = () => loadRecipe(name);
    grid.appendChild(card);
  }
}

/* ---------- Load single recipe ---------- */

async function loadRecipe(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  currentRecipe = name;

  document.getElementById("recipe-content").innerHTML =
    marked.parse(markdown);

  rewriteImages(name);
  showRecipe();
}

function rewriteImages(recipe) {
  document.querySelectorAll("#recipe-content img").forEach(img => {
    const filename = img.getAttribute("src").split("/").pop();
    img.src =
      `${API}/photos/${encodeURIComponent(recipe)}/${encodeURIComponent(filename)}`;
  });
}

/* ---------- Edit recipe ---------- */

async function editCurrentRecipe() {
  if (!currentRecipe) return;

  const res = await fetch(`${API}/recipes/${encodeURIComponent(currentRecipe)}`);
  const markdown = await res.text();

  recipeName.value = currentRecipe;
  recipeMarkdown.value = markdown;
  photoInput.value = "";

  showGrid();
}

/* ---------- Save recipe ---------- */

async function saveRecipe() {
  const name = recipeName.value.trim();
  const markdown = recipeMarkdown.value;
  const photo = photoInput.files[0];

  if (!name || !markdown) {
    alert("Name and markdown required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);
  if (photo) form.append("photo", photo);

  const res = await fetch(`${API}/recipes`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    alert("Save failed");
    return;
  }

  recipeName.value = "";
  recipeMarkdown.value = "";
  photoInput.value = "";

  showGrid();
  loadRecipes();
}

/* ---------- Init ---------- */

const recipeName = document.getElementById("recipe-name");
const recipeMarkdown = document.getElementById("recipe-markdown");
const photoInput = document.getElementById("photo-input");

loadRecipes();
</script>
</body>
</html>
