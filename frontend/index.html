<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipes</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="layout">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <h2>Library</h2>
    <input class="search" placeholder="Search (coming soon)" />

    <button class="primary" onclick="openImport()">➕ Import Recipe</button>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <div id="recipe-grid" class="grid"></div>
  </main>

</div>

<script>
const API = "http://192.168.1.3:9001/api";

/* ---------- Ensure grid exists ---------- */

function ensureGridView() {
  const content = document.querySelector(".content");
  let grid = document.getElementById("recipe-grid");

  // If we're currently in import/edit/recipe view, the grid container is gone.
  if (!grid) {
    content.innerHTML = `<div id="recipe-grid" class="grid"></div>`;
    grid = document.getElementById("recipe-grid");
  }

  return grid;
}

/* ---------- Cover image helper ---------- */

async function getCoverImage(recipe) {
  try {
    const res = await fetch(`${API}/recipes/${encodeURIComponent(recipe)}/cover`);
    if (!res.ok) return null;
    const data = await res.json();
    if (!data.url) return null;
    return API + data.url;
  } catch {
    return null;
  }
}

/* ---------- Grid ---------- */

async function loadRecipes() {
  const grid = ensureGridView();

  const res = await fetch(`${API}/recipes`);
  const recipes = await res.json();

  grid.innerHTML = "";

  for (const name of recipes) {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("div");
    img.className = "card-image";

    const cover = await getCoverImage(name);
    if (cover) {
      img.style.backgroundImage = `url('${cover}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = name;

    card.appendChild(img);
    card.appendChild(title);

    card.onclick = () => loadRecipe(name);
    grid.appendChild(card);
  }
}

/* ---------- View recipe ---------- */

async function loadRecipe(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  const html = marked.parse(markdown);

  document.querySelector(".content").innerHTML = `
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
      <button onclick="loadRecipes()">← Back</button>
      <button onclick="openEdit('${escapeHtmlAttr(name)}')">✏️ Edit</button>
    </div>
    <div class="recipe">${html}</div>
  `;

  rewriteImages(name);
}

function rewriteImages(recipe) {
  document.querySelectorAll(".recipe img").forEach(img => {
    const src = img.getAttribute("src") || "";
    if (src.startsWith("http") || src.startsWith("data:")) return;

    const filename = src.split("/").pop();
    img.src = `${API}/photos/${encodeURIComponent(recipe)}/${encodeURIComponent(filename)}`;
  });
}

/* ---------- Import / Edit ---------- */

function openImport() {
  document.querySelector(".content").innerHTML = `
    <h2>Import Recipe</h2>
    <input id="recipe-name" placeholder="Recipe name" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>
    <input type="file" id="photo-input" />
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="primary" onclick="saveRecipe()">Save</button>
      <button onclick="loadRecipes()">Cancel</button>
    </div>
  `;
}

async function openEdit(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  document.querySelector(".content").innerHTML = `
    <h2>Edit Recipe</h2>
    <input id="recipe-name" value="${escapeHtmlAttr(name)}" />
    <textarea id="recipe-markdown">${escapeHtmlText(markdown)}</textarea>
    <input type="file" id="photo-input" />
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="primary" onclick="saveRecipe()">Save</button>
      <button onclick="loadRecipes()">Cancel</button>
    </div>
  `;
}

/* ---------- Save ---------- */

async function saveRecipe() {
  const nameEl = document.getElementById("recipe-name");
  const mdEl = document.getElementById("recipe-markdown");
  const photoEl = document.getElementById("photo-input");

  if (!nameEl || !mdEl) {
    alert("Missing form fields (UI not loaded).");
    return;
  }

  const name = nameEl.value.trim();
  const markdown = mdEl.value;
  const photo = photoEl?.files?.[0];

  if (!name || !markdown) {
    alert("Name and markdown required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);
  if (photo) form.append("photo", photo);

  const res = await fetch(`${API}/recipes`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    alert("Save failed");
    return;
  }

  loadRecipes();
}

/* ---------- tiny HTML safety helpers ---------- */

function escapeHtmlAttr(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function escapeHtmlText(str) {
  // for textarea innerHTML
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

loadRecipes();
</script>
</body>
</html>
