<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recipes</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<link rel="stylesheet" href="/css/base.css" />
<link rel="stylesheet" href="/css/layout.css" />
<link rel="stylesheet" href="/css/components.css" />
<link rel="stylesheet" href="/css/modal.css" />
<link rel="stylesheet" href="/css/mobile.css" />
</head>

<body>

<div id="app"></div>

<script>
const API = "/api";

function api(url, options = {}) {
  return fetch(url, {
    credentials: "include",
    ...options
  });
}

let allRecipes = [];
let currentRecipe = null;
let activeTag = null;
let isEditing = false;
let currentView = "grid";

/* =========================
   BOOT
========================= */

async function boot() {
  const res = await api(`${API}/auth-check`);
  const data = await res.json();

  if (data.authenticated) {
    renderApp();
    loadRecipes();
  } else {
    renderLogin();
  }
}

/* =========================
   LOGIN
========================= */

function renderLogin() {
  document.getElementById("app").innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;">
      <form id="login-form" style="width:300px;display:flex;flex-direction:column;gap:10px;">
        <h2>Login</h2>
        <input name="username" placeholder="Username" required />
        <input name="password" type="password" placeholder="Password" required />
        <button class="primary">Login</button>
      </form>
    </div>
  `;

  document.getElementById("login-form").onsubmit = async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);

    const res = await api(`${API}/login`, {
      method: "POST",
      body: form
    });

    if (res.ok) {
      renderApp();
      loadRecipes();
    } else {
      alert("Invalid credentials");
    }
  };
}

/* =========================
   MAIN APP
========================= */

function renderApp() {
  document.getElementById("app").innerHTML = `
  <div class="layout">
    <aside class="sidebar">
      <h2>Library</h2>
      <input class="search" placeholder="Search" oninput="renderGrid()" />
      <div class="tags">
        <h4>Tags</h4>
        <ul id="tag-list"></ul>
      </div>
      <button class="primary" onclick="openImport()">+ Import Recipe</button>
      <button onclick="logout()">Logout</button>
    </aside>
    <main class="content">
      <div id="grid-view">
        <div class="view-toggle">
          <button id="gridBtn" class="toggle active" onclick="setView('grid')">Grid</button>
          <button id="listBtn" class="toggle" onclick="setView('list')">List</button>
        </div>
        <div id="recipe-grid" class="grid"></div>
      </div>
      <div id="recipe-view" style="display:none;"></div>
    </main>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal hidden">
    <div class="modal-card">
      <h3 id="modal-title"></h3>
      <input id="recipe-name" placeholder="Recipe name" />
      <input id="recipe-tags" placeholder="Tags (space separated)" />
      <textarea id="recipe-markdown" placeholder="Markdown"></textarea>
      <input type="file" id="photo-input" />
      <div class="modal-actions">
        <button onclick="closeModal()">Cancel</button>
        <button class="primary" onclick="saveRecipe()">Save</button>
      </div>
    </div>
  </div>
  `;
}

/* =========================
   VIEW TOGGLE
========================= */

function setView(view) {
  currentView = view;

  document.getElementById("recipe-grid").className = view;

  document.getElementById("gridBtn").classList.remove("active");
  document.getElementById("listBtn").classList.remove("active");

  if (view === "grid") {
    document.getElementById("gridBtn").classList.add("active");
  } else {
    document.getElementById("listBtn").classList.add("active");
  }
}

/* =========================
   LOGOUT
========================= */

async function logout() {
  await api(`${API}/logout`, { method: "POST" });
  renderLogin();
}

/* =========================
   LOAD
========================= */

async function loadRecipes() {
  const res = await api(`${API}/recipes`);
  if (!res.ok) return renderLogin();
  allRecipes = await res.json();
  renderTags();
  renderGrid();
}

/* =========================
   TAGS
========================= */

function renderTags() {
  const set = new Set();
  allRecipes.forEach(r => (r.tags || []).forEach(t => set.add(t)));

  const ul = document.getElementById("tag-list");
  ul.innerHTML = "";

  const all = document.createElement("li");
  all.textContent = "All Recipes";
  all.onclick = () => { activeTag = null; renderGrid(); };
  ul.appendChild(all);

  [...set].sort().forEach(tag => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";

    const name = document.createElement("span");
    name.textContent = tag;
    name.onclick = () => { activeTag = tag; renderGrid(); };

    const del = document.createElement("span");
    del.textContent = "üóë";
    del.style.cursor = "pointer";
    del.onclick = async () => {
      if (!confirm(`Delete tag "${tag}"?`)) return;
      const res = await api(`${API}/tags/${encodeURIComponent(tag)}`, {
        method: "DELETE"
      });
      if (res.ok) loadRecipes();
    };

    li.appendChild(name);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

/* =========================
   GRID / LIST RENDER
========================= */

function renderGrid() {
  const grid = document.getElementById("recipe-grid");
  grid.innerHTML = "";
  grid.className = currentView;

  const visible = allRecipes.filter(r =>
    !activeTag || r.tags.includes(activeTag)
  );

  visible.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("div");
    img.className = "card-image";
    if (r.cover) {
      img.style.backgroundImage =
        `url('${API}/photos/${encodeURIComponent(r.name)}/${encodeURIComponent(r.cover)}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = r.name;

    card.appendChild(img);
    card.appendChild(title);
    card.onclick = () => openRecipe(r.name);

    grid.appendChild(card);
  });
}

/* =========================
   OPEN / EDIT / DELETE
========================= */

async function openRecipe(name) {
  currentRecipe = name;

  const res = await api(`${API}/recipes/${encodeURIComponent(name)}`);
  if (!res.ok) return renderLogin();

  const md = await res.text();
  const html = marked.parse(md.replace(/^Tags:.*\n+/m, ""));

  document.getElementById("grid-view").style.display = "none";
  const view = document.getElementById("recipe-view");
  view.style.display = "block";

  view.innerHTML = `
    <div class="recipe-header">
      <button class="icon-btn" onclick="goBack()">‚Üê</button>
      <div class="recipe-actions">
        <button class="icon-btn" onclick="editRecipe()">‚úèÔ∏è</button>
        <button class="icon-btn" onclick="window.print()">üñ®</button>
        <button class="icon-btn danger" onclick="deleteRecipe()">üóë</button>
      </div>
    </div>
    <article class="recipe">
      <h1>${name}</h1>
      ${html}
    </article>
  `;
}

/* =========================
   IMPORT / EDIT / SAVE
========================= */

function openImport() {
  isEditing = false;
  document.getElementById("modal-title").textContent = "Import Recipe";
  document.getElementById("recipe-name").value = "";
  document.getElementById("recipe-tags").value = "";
  document.getElementById("recipe-markdown").value = "";
  document.getElementById("photo-input").value = "";
  document.getElementById("modal").classList.remove("hidden");
}

async function editRecipe() {
  isEditing = true;

  const res = await api(`${API}/recipes/${encodeURIComponent(currentRecipe)}`);
  const md = await res.text();

  document.getElementById("modal-title").textContent = "Edit Recipe";
  document.getElementById("recipe-name").value = currentRecipe;
  document.getElementById("recipe-markdown").value =
    md.replace(/^Tags:.*\n+/m, "");

  const recipe = allRecipes.find(r => r.name === currentRecipe);
  document.getElementById("recipe-tags").value =
    recipe?.tags.join(" ") || "";

  document.getElementById("modal").classList.remove("hidden");
}

async function saveRecipe() {
  const name = document.getElementById("recipe-name").value.trim();
  const markdown = document.getElementById("recipe-markdown").value;
  const tags = document.getElementById("recipe-tags").value;
  const photo = document.getElementById("photo-input").files[0];

  if (!name || !markdown) {
    alert("Name and markdown required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);
  form.append("tags", tags);
  if (photo) form.append("photo", photo);

  await api(`${API}/recipes`, {
    method: "POST",
    body: form
  });

  closeModal();
  loadRecipes();
  if (isEditing) goBack();
}

async function deleteRecipe() {
  if (!confirm("Delete this recipe?")) return;

  const res = await api(`${API}/recipes/${encodeURIComponent(currentRecipe)}`, {
    method: "DELETE"
  });

  if (res.ok) {
    goBack();
    loadRecipes();
  }
}

/* =========================
   BACK / MODAL
========================= */

function goBack() {
  document.getElementById("recipe-view").style.display = "none";
  document.getElementById("grid-view").style.display = "block";
}

function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}

boot();
</script>

</body>
</html>
