<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipes</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }

    .layout {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      padding: 16px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }

    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    ul {
      padding-left: 0;
      list-style: none;
    }

    li {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    li span {
      flex: 1;
      cursor: pointer;
    }

    button {
      margin-left: 6px;
    }

    textarea {
      width: 100%;
      height: 160px;
    }

    input[type="text"] {
      width: 100%;
      margin-bottom: 8px;
    }

    img {
      max-width: 100%;
      display: block;
      margin-top: 16px;
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Recipes</h2>
    <ul id="recipe-list"></ul>

    <hr>

    <h3 id="editor-title">Paste Markdown</h3>

    <input id="recipe-name" placeholder="Recipe name" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>

    <button onclick="saveRecipe()">Save Recipe</button>

    <h3>Add Photo</h3>
    <input type="file" id="photo-input" />
  </div>

  <!-- CONTENT -->
  <div class="content">
    <h1 id="viewer-title">Select a recipe</h1>
    <div id="recipe-content"></div>
  </div>

</div>

<script>
const API = "http://192.168.1.3:9001/api";

let currentRecipe = null;
let editing = false;

/* ---------- Helpers ---------- */

function normalizeMarkdown(text) {
  return text
    .replace(/\uFEFF/g, "")
    .replace(/\r\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n");
}

function rewriteImageUrls(html, recipeName) {
  const div = document.createElement("div");
  div.innerHTML = html;

  div.querySelectorAll("img").forEach(img => {
    const src = img.getAttribute("src");
    if (!src) return;
    if (src.startsWith("http") || src.startsWith("data:")) return;

    const filename = src.split("/").pop();
    img.src = `${API}/photos/${encodeURIComponent(recipeName)}/${encodeURIComponent(filename)}`;
  });

  return div.innerHTML;
}

/* ---------- Load recipe list ---------- */

async function loadRecipes() {
  const res = await fetch(`${API}/recipes`);
  const recipes = await res.json();

  const list = document.getElementById("recipe-list");
  list.innerHTML = "";

  if (!recipes.length) {
    list.innerHTML = "<li><em>No recipes found</em></li>";
    return;
  }

  recipes.forEach(name => {
    const li = document.createElement("li");

    const label = document.createElement("span");
    label.textContent = name;
    label.onclick = () => loadRecipe(name);

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸";
    editBtn.onclick = () => startEdit(name);

    const delBtn = document.createElement("button");
    delBtn.textContent = "ðŸ—‘";
    delBtn.onclick = () => deleteRecipe(name);

    li.appendChild(label);
    li.appendChild(editBtn);
    li.appendChild(delBtn);
    list.appendChild(li);
  });
}

/* ---------- Load recipe ---------- */

async function loadRecipe(name) {
  editing = false;
  currentRecipe = name;

  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  const html = marked.parse(normalizeMarkdown(markdown));
  document.getElementById("recipe-content").innerHTML =
    rewriteImageUrls(html, name);

  document.getElementById("viewer-title").textContent = name;
}

/* ---------- Start edit ---------- */

async function startEdit(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  editing = true;
  currentRecipe = name;

  document.getElementById("recipe-name").value = name;
  document.getElementById("recipe-markdown").value = markdown;
  document.getElementById("editor-title").textContent = "Edit Recipe";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ---------- Save recipe ---------- */

async function saveRecipe() {
  const name = document.getElementById("recipe-name").value.trim();
  const markdown = document.getElementById("recipe-markdown").value;
  const photoInput = document.getElementById("photo-input");

  if (!name || !markdown) {
    alert("Recipe name and markdown are required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);

  if (photoInput.files.length > 0) {
    form.append("photo", photoInput.files[0]);
  }

  const res = await fetch(`${API}/recipes`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    alert("Failed to save recipe");
    return;
  }

  editing = false;
  currentRecipe = name;

  document.getElementById("recipe-name").value = "";
  document.getElementById("recipe-markdown").value = "";
  photoInput.value = "";
  document.getElementById("editor-title").textContent = "Paste Markdown";

  await loadRecipes();
  await loadRecipe(name);
}

/* ---------- Delete ---------- */

async function deleteRecipe(name) {
  if (!confirm(`Delete "${name}"?\nThis cannot be undone.`)) return;

  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`, {
    method: "DELETE"
  });

  if (!res.ok) {
    alert("Failed to delete recipe");
    return;
  }

  if (currentRecipe === name) {
    document.getElementById("recipe-content").innerHTML = "";
    document.getElementById("viewer-title").textContent = "Select a recipe";
    currentRecipe = null;
  }

  await loadRecipes();
}

loadRecipes();
</script>
</body>
</html>
