<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recipes</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<link rel="stylesheet" href="css/base.css" />
<link rel="stylesheet" href="css/layout.css" />
<link rel="stylesheet" href="css/components.css" />
<link rel="stylesheet" href="css/modal.css" />
<link rel="stylesheet" href="css/mobile.css" />
<link rel="stylesheet" href="css/print.css" />
</head>

<body>
<div id="app"></div>

<script>
const API = "/api";

function api(url, options = {}) {
  return fetch(url, {
    credentials: "include",
    ...options
  });
}

let allRecipes = [];
let activeTag = null;
let currentView = "grid";
let currentRecipe = null;
let isEditing = false;

/* =========================
   BOOT
========================= */

async function boot() {
  const res = await api(`${API}/auth-check`);
  const data = await res.json();

  if (data.authenticated) {
    renderApp();
    await loadRecipes();
  } else {
    renderLogin();
  }
}

/* =========================
   LOGIN
========================= */

function renderLogin() {
  document.getElementById("app").innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;">
      <form id="login-form" style="width:300px;display:flex;flex-direction:column;gap:10px;">
        <h2>Login</h2>
        <input name="username" placeholder="Username" required />
        <input name="password" type="password" placeholder="Password" required />
        <button class="primary">Login</button>
      </form>
    </div>
  `;

  document.getElementById("login-form").onsubmit = async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);

    const res = await api(`${API}/login`, { method: "POST", body: form });

    if (res.ok) {
      renderApp();
      await loadRecipes();
    } else {
      alert("Invalid credentials");
    }
  };
}

/* =========================
   APP SHELL
========================= */

function renderApp() {
  document.getElementById("app").innerHTML = `
  <div class="layout">

    <aside class="sidebar">
      <h2>Library</h2>

      <input class="search" placeholder="Search" oninput="renderGrid()" />

      <div class="tags">
        <h4>Tags</h4>
        <ul id="tag-list"></ul>
      </div>

      <button class="primary" onclick="openImport()">+ Import Recipe</button>
      <button onclick="logout()">Logout</button>
    </aside>

    <main class="content">

      <div id="grid-view">
        <div class="view-toggle">
          <button id="gridBtn" class="toggle active" onclick="setView('grid')">Grid</button>
          <button id="listBtn" class="toggle" onclick="setView('list')">List</button>
        </div>

        <div id="recipe-grid" class="grid"></div>
      </div>

      <div id="recipe-view" style="display:none;"></div>

    </main>

  </div>

  <!-- MODAL -->
  <div id="modal" class="modal hidden">
    <div class="modal-card">
      <h3 id="modal-title">Import Recipe</h3>

      <input id="recipe-name" placeholder="Recipe name" />
      <input id="recipe-tags" placeholder="Tags (space separated)" />
      <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>
      <input type="file" id="photo-input" />

      <div class="modal-actions">
        <button onclick="closeModal()">Cancel</button>
        <button class="primary" onclick="saveRecipe()">Save</button>
      </div>
    </div>
  </div>
  `;
}

/* =========================
   LOAD
========================= */

async function loadRecipes() {
  const res = await api(`${API}/recipes`);
  if (!res.ok) {
    renderLogin();
    return;
  }

  allRecipes = await res.json();
  renderTags();
  renderGrid();
}

/* =========================
   GRID / LIST
========================= */

function setView(view) {
  currentView = view;
  document.getElementById("gridBtn").classList.toggle("active", view === "grid");
  document.getElementById("listBtn").classList.toggle("active", view === "list");
  renderGrid();
}

function renderGrid() {
  const grid = document.getElementById("recipe-grid");
  if (!grid) return;

  grid.className = currentView === "list" ? "list" : "grid";
  grid.innerHTML = "";

  const q = document.querySelector(".search")?.value.toLowerCase() || "";

  const visible = allRecipes.filter(r => {
    if (activeTag && !(r.tags || []).includes(activeTag)) return false;
    if (q && !r.name.toLowerCase().includes(q)) return false;
    return true;
  });

  visible.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("div");
    img.className = "card-image";

    if (r.cover) {
      img.style.backgroundImage =
        `url('${API}/photos/${encodeURIComponent(r.name)}/${encodeURIComponent(r.cover)}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = r.name;

    card.appendChild(img);
    card.appendChild(title);
    card.onclick = () => openRecipe(r.name);

    grid.appendChild(card);
  });
}

/* =========================
   TAGS
========================= */

function renderTags() {
  const set = new Set();
  allRecipes.forEach(r => (r.tags || []).forEach(t => set.add(t)));

  const ul = document.getElementById("tag-list");
  ul.innerHTML = "";

  const all = document.createElement("li");
  all.textContent = "All Recipes";
  all.onclick = () => { activeTag = null; renderGrid(); };
  ul.appendChild(all);

  [...set].sort().forEach(tag => {
    const li = document.createElement("li");
    li.className = "tag-item";

    const name = document.createElement("span");
    name.textContent = tag;
    name.onclick = () => {
      activeTag = tag;
      renderGrid();
    };

    const del = document.createElement("button");
    del.className = "tag-delete";
    del.textContent = "üóë";
    del.onclick = (e) => {
      e.stopPropagation();
      deleteTag(tag);
    };

    li.appendChild(name);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

async function deleteTag(tag) {
  if (!confirm(`Delete tag "${tag}" from all recipes?`)) return;

  for (const recipe of allRecipes) {
    if (!(recipe.tags || []).includes(tag)) continue;

    const res = await api(`${API}/recipes/${encodeURIComponent(recipe.name)}`);
    const md = await res.text();

    const clean = md.replace(/^Tags:.*\n+/m, "");
    const newTags = (recipe.tags || []).filter(t => t !== tag).join(" ");

    const form = new FormData();
    form.append("name", recipe.name);
    form.append("markdown", clean);
    form.append("tags", newTags);

    await api(`${API}/recipes`, { method: "POST", body: form });
  }

  await loadRecipes();
}

/* =========================
   OPEN RECIPE
========================= */

async function openRecipe(name) {
  currentRecipe = name;

  const res = await api(`${API}/recipes/${encodeURIComponent(name)}`);
  let md = await res.text();
  md = md.replace(/^Tags:.*\n+/m, "");

  const html = marked.parse(md);
  const recipe = allRecipes.find(r => r.name === name);

  document.getElementById("grid-view").style.display = "none";
  const view = document.getElementById("recipe-view");
  view.style.display = "block";

  const coverHtml = recipe?.cover
    ? `<img src="${API}/photos/${encodeURIComponent(name)}/${encodeURIComponent(recipe.cover)}"
            style="width:380px; max-width:40vw; border-radius:12px;" />`
    : "";

  view.innerHTML = `
    <div class="recipe-header no-print">
      <button class="icon-btn" onclick="goBack()">‚Üê</button>
      <div class="recipe-actions">
        <button class="icon-btn" onclick="editRecipe('${name}')">‚úèÔ∏è</button>
        <button class="icon-btn" onclick="window.print()">üñ®</button>
        <button class="icon-btn danger" onclick="deleteRecipe('${name}')">üóë</button>
      </div>
    </div>

    <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
      <div style="flex:1; min-width:280px;">
        <h1>${name}</h1>
        ${html}
      </div>
      <div style="min-width:220px;">
        ${coverHtml}
      </div>
    </div>
  `;
}

function goBack() {
  document.getElementById("recipe-view").style.display = "none";
  document.getElementById("grid-view").style.display = "block";
}

/* ========================= */

boot();
</script>
</body>
</html>
