<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recipes</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<link rel="stylesheet" href="/css/base.css" />
<link rel="stylesheet" href="/css/layout.css" />
<link rel="stylesheet" href="/css/components.css" />
<link rel="stylesheet" href="/css/modal.css" />
<link rel="stylesheet" href="/css/print.css" />
<link rel="stylesheet" href="/css/mobile.css" />
</head>

<body>
<div class="layout">

<aside class="sidebar">
  <h2>Library</h2>

  <input class="search" placeholder="Search" oninput="renderGrid()" />

  <div class="tags">
    <h4>Tags</h4>
    <ul id="tag-list"></ul>
  </div>

  <button class="primary" onclick="openImport()">+ Import Recipe</button>
</aside>

<main class="content">
  <div class="view-toggle">
    <button class="toggle active" onclick="setView('grid')">Grid</button>
    <button class="toggle" onclick="setView('list')">List</button>
  </div>

  <div id="recipe-grid" class="grid"></div>
</main>

</div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <h3 id="modal-title">Import Recipe</h3>

    <input id="recipe-name" placeholder="Recipe name" />
    <input id="recipe-tags" placeholder="Tags (comma separated)" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>
    <input type="file" id="photo-input" />

    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="primary" onclick="saveRecipe()">Save</button>
    </div>
  </div>
</div>

<script>
const API = "/api";

let allRecipes = [];
let activeTag = null;
let currentView = "grid";
let currentRecipe = null;

/* =========================
   UTIL
========================= */

function showLoading() {
  document.querySelector(".content").innerHTML =
    `<div class="loading">Loading‚Ä¶</div>`;
}

/* =========================
   LOAD
========================= */

async function loadRecipes() {
  showLoading();

  const res = await fetch(`${API}/recipes`);
  allRecipes = await res.json();

  document.querySelector(".content").innerHTML = `
    <div class="view-toggle">
      <button class="toggle ${currentView === 'grid' ? 'active' : ''}" onclick="setView('grid')">Grid</button>
      <button class="toggle ${currentView === 'list' ? 'active' : ''}" onclick="setView('list')">List</button>
    </div>
    <div id="recipe-grid" class="${currentView}"></div>
  `;

  renderTags();
  renderGrid();
}

function goBack() {
  currentRecipe = null;
  loadRecipes();
}

/* =========================
   VIEW TOGGLE
========================= */

function setView(view) {
  currentView = view;
  loadRecipes();
}

/* =========================
   TAGS
========================= */

function renderTags() {
  const set = new Set();
  allRecipes.forEach(r => (r.tags || []).forEach(t => set.add(t)));

  const ul = document.getElementById("tag-list");
  ul.innerHTML = "";

  const all = document.createElement("li");
  all.textContent = "All Recipes";
  all.onclick = () => { activeTag = null; renderGrid(); };
  ul.appendChild(all);

  [...set].sort().forEach(tag => {
    const li = document.createElement("li");
    li.className = "tag-item";

    const name = document.createElement("span");
    name.textContent = tag;
    name.onclick = () => {
      activeTag = tag;
      renderGrid();
    };

    const del = document.createElement("button");
    del.className = "tag-delete";
    del.textContent = "üóë";
    del.onclick = (e) => {
      e.stopPropagation();
      deleteTag(tag);
    };

    li.appendChild(name);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

/* =========================
   DELETE TAG
========================= */

async function deleteTag(tag) {
  if (!confirm(`Delete tag "${tag}" from all recipes?`)) return;

  for (const recipe of allRecipes) {
    if ((recipe.tags || []).includes(tag)) {
      const updatedTags = recipe.tags.filter(t => t !== tag).join(", ");

      const res = await fetch(`${API}/recipes/${encodeURIComponent(recipe.name)}`);
      const md = await res.text();
      const clean = md.replace(/^Tags:.*\n+/m, "");

      const form = new FormData();
      form.append("name", recipe.name);
      form.append("markdown", clean);
      form.append("tags", updatedTags);

      await fetch(`${API}/recipes`, { method: "POST", body: form });
    }
  }

  loadRecipes();
}

/* =========================
   GRID / LIST
========================= */

function renderGrid() {
  const grid = document.getElementById("recipe-grid");
  if (!grid) return;

  grid.innerHTML = "";

  const searchEl = document.querySelector(".search");
  const q = (searchEl ? searchEl.value : "").toLowerCase();

  const visible = allRecipes.filter(r => {
    const tags = r.tags || [];
    if (activeTag && !tags.includes(activeTag)) return false;
    if (q && !r.name.toLowerCase().includes(q)) return false;
    return true;
  });

  visible.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("div");
    img.className = "card-image";

    if (r.cover) {
      img.style.backgroundImage =
        `url('${API}/photos/${encodeURIComponent(r.name)}/${encodeURIComponent(r.cover)}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = r.name;

    card.appendChild(img);
    card.appendChild(title);
    card.onclick = () => openRecipe(r.name);

    grid.appendChild(card);
  });
}

/* =========================
   OPEN RECIPE
========================= */

async function openRecipe(name) {
  currentRecipe = name;
  showLoading();

  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const md = await res.text();

  const html = marked.parse(md.replace(/^Tags:.*\n+/m, ""));
  const recipe = allRecipes.find(r => r.name === name);
  const tags = recipe?.tags || [];

  document.querySelector(".content").innerHTML = `
    <div class="recipe-header no-print">
      <button class="icon-btn" onclick="goBack()">‚Üê</button>
      <button class="icon-btn" onclick="editRecipe('${name}')">‚úèÔ∏è</button>
      <button class="icon-btn" onclick="window.print()">üñ®</button>
      <button class="icon-btn danger" onclick="deleteRecipe()">üóë</button>
    </div>

    <article class="recipe">
      <h1>${name}</h1>
      ${tags.length ? `<div class="recipe-meta">Tags: ${tags.join(", ")}</div>` : ""}
      ${html}
    </article>
  `;

  rewriteImages(name);
}

/* =========================
   EDIT
========================= */

async function editRecipe(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const md = await res.text();

  recipeName.value = name;
  recipeMarkdown.value = md.replace(/^Tags:.*\n+/m, "");

  const recipe = allRecipes.find(r => r.name === name);
  recipeTags.value = (recipe?.tags || []).join(", ");

  document.getElementById("modal-title").textContent = "Edit Recipe";
  document.getElementById("modal").classList.remove("hidden");
}

/* =========================
   DELETE RECIPE
========================= */

async function deleteRecipe() {
  if (!confirm("Delete this recipe?")) return;

  await fetch(`${API}/recipes/${encodeURIComponent(currentRecipe)}`, {
    method: "DELETE"
  });

  goBack();
}

/* =========================
   SAVE (Import + Edit)
========================= */

async function saveRecipe() {
  const name = recipeName.value.trim();
  const markdown = recipeMarkdown.value;
  const tags = recipeTags.value;
  const photo = photoInput.files[0];

  if (!name || !markdown) {
    alert("Name and markdown required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);
  form.append("tags", tags);
  if (photo) form.append("photo", photo);

  await fetch(`${API}/recipes`, { method: "POST", body: form });

  closeModal();
  loadRecipes();
}

/* =========================
   IMAGES
========================= */

function rewriteImages(recipe) {
  document.querySelectorAll(".recipe img").forEach(img => {
    const file = img.getAttribute("src").split("/").pop();
    img.src =
      `${API}/photos/${encodeURIComponent(recipe)}/${encodeURIComponent(file)}`;
  });
}

/* =========================
   MODAL
========================= */

function openImport() {
  document.getElementById("modal-title").textContent = "Import Recipe";
  recipeName.value = "";
  recipeTags.value = "";
  recipeMarkdown.value = "";
  photoInput.value = "";
  document.getElementById("modal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}

/* =========================
   INIT
========================= */

const recipeName = document.getElementById("recipe-name");
const recipeTags = document.getElementById("recipe-tags");
const recipeMarkdown = document.getElementById("recipe-markdown");
const photoInput = document.getElementById("photo-input");

loadRecipes();
</script>

</body>
</html>
