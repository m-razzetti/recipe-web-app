<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipes</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }

    .layout {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      padding: 16px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }

    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    ul {
      padding-left: 20px;
    }

    li {
      cursor: pointer;
      margin-bottom: 6px;
    }

    textarea {
      width: 100%;
      height: 160px;
    }

    input[type="text"] {
      width: 100%;
      margin-bottom: 8px;
    }

    img {
      max-width: 100%;
      display: block;
      margin-top: 16px;
    }

    button {
      margin-left: 6px;
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- LEFT SIDEBAR -->
  <div class="sidebar">
    <h2>Recipes</h2>
    <ul id="recipe-list"></ul>

    <hr>

    <h3>Paste Markdown</h3>
    <input id="recipe-name" placeholder="Recipe name" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>

    <input type="file" id="photo-input" />
    <button onclick="saveRecipe()">Save Recipe</button>
  </div>

  <!-- RIGHT CONTENT -->
  <div class="content">
    <div style="display:flex; align-items:center; gap:8px;">
      <h1 id="recipe-title">Select a recipe</h1>
      <button id="edit-btn" style="display:none" onclick="editCurrentRecipe()">Edit</button>
      <button id="delete-btn" style="display:none" onclick="deleteCurrentRecipe()">Delete</button>
    </div>

    <div id="recipe-content"></div>
  </div>

</div>

<script>
const API = "http://192.168.1.3:9001/api";

let currentRecipe = null;
let editingOriginalName = null;

/* ---------- Helpers ---------- */

function normalizeMarkdown(text) {
  return text
    .replace(/\uFEFF/g, "")        // BOM
    .replace(/\r\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n");
}

function rewriteImageUrls(html, recipeName) {
  const div = document.createElement("div");
  div.innerHTML = html;

  div.querySelectorAll("img").forEach(img => {
    const src = img.getAttribute("src");
    if (!src) return;
    if (src.startsWith("http") || src.startsWith("data:")) return;

    const filename = src.split("/").pop();
    img.src =
      `${API}/photos/` +
      `${encodeURIComponent(recipeName)}/` +
      `${encodeURIComponent(filename)}`;
  });

  return div.innerHTML;
}

/* ---------- Load recipe list ---------- */

async function loadRecipes() {
  const res = await fetch(`${API}/recipes`);
  const recipes = await res.json();

  const list = document.getElementById("recipe-list");
  list.innerHTML = "";

  if (!recipes.length) {
    list.innerHTML = "<li><em>No recipes found</em></li>";
    return;
  }

  recipes.forEach(name => {
    const li = document.createElement("li");
    li.textContent = name;
    li.onclick = () => loadRecipe(name);
    list.appendChild(li);
  });
}

/* ---------- Load recipe ---------- */

async function loadRecipe(name) {
  currentRecipe = name;
  editingOriginalName = null;

  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const markdown = await res.text();

  const cleaned = normalizeMarkdown(markdown);
  const html = marked.parse(cleaned);
  const finalHtml = rewriteImageUrls(html, name);

  document.getElementById("recipe-content").innerHTML = finalHtml;
  document.getElementById("recipe-title").textContent = name;

  document.getElementById("edit-btn").style.display = "inline-block";
  document.getElementById("delete-btn").style.display = "inline-block";
}

/* ---------- Edit ---------- */

async function editCurrentRecipe() {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(currentRecipe)}`);
  document.getElementById("recipe-name").value = currentRecipe;
  document.getElementById("recipe-markdown").value = await res.text();

  editingOriginalName = currentRecipe;
}

/* ---------- Delete ---------- */

async function deleteCurrentRecipe() {
  if (!currentRecipe) return;

  if (!confirm(`Delete "${currentRecipe}" permanently?`)) return;

  const res = await fetch(`${API}/recipes/${encodeURIComponent(currentRecipe)}`, {
    method: "DELETE"
  });

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  currentRecipe = null;
  editingOriginalName = null;

  document.getElementById("recipe-content").innerHTML = "";
  document.getElementById("recipe-title").textContent = "Select a recipe";
  document.getElementById("edit-btn").style.display = "none";
  document.getElementById("delete-btn").style.display = "none";

  await loadRecipes();
}

/* ---------- Save (create / edit / rename) ---------- */

async function saveRecipe() {
  try {
    const name = document.getElementById("recipe-name").value.trim();
    const markdown = document.getElementById("recipe-markdown").value;
    const photoInput = document.getElementById("photo-input");

    if (!name || !markdown) {
      alert("Recipe name and markdown are required");
      return;
    }

    const form = new FormData();
    form.append("name", name);
    form.append("markdown", markdown);

    if (editingOriginalName) {
      form.append("original_name", editingOriginalName);
    }

    if (photoInput.files.length > 0) {
      form.append("photo", photoInput.files[0]);
    }

    const res = await fetch(`${API}/recipes`, {
      method: "POST",
      body: form
    });

    if (!res.ok) {
      alert("Save failed");
      return;
    }

    // reset edit state
    editingOriginalName = null;
    photoInput.value = "";

    await loadRecipes();
    await loadRecipe(name);

  } catch (err) {
    console.error("Save failed:", err);
    alert("Save failed â€” check console");
  }
}

/* ---------- Init ---------- */

loadRecipes();
</script>
</body>
</html>
