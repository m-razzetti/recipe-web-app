<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipes</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Library</h2>

    <input
      id="search"
      class="search"
      placeholder="Search recipes..."
    />

    <div class="tags">
      <h4>Tags</h4>
      <ul id="tag-list"></ul>
    </div>

    <button class="primary" id="importBtn">+ Import Recipe</button>
  </aside>

  <!-- MAIN -->
  <main class="content">
    <div id="view"></div>
  </main>

</div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <h3 id="modal-title">Import Recipe</h3>

    <input id="recipe-name" placeholder="Recipe name" />
    <input id="recipe-tags" placeholder="Tags (comma separated)" />
    <textarea id="recipe-markdown" placeholder="Paste markdown here..."></textarea>

    <input type="file" id="photo-input" />

    <div class="modal-actions">
      <button id="cancelBtn">Cancel</button>
      <button class="primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
const API = "http://192.168.1.3:9001/api";

let allRecipes = [];
let activeTag = null;
let searchQuery = "";

/* ---------- Init ---------- */

document.getElementById("search").addEventListener("input", e => {
  searchQuery = e.target.value.toLowerCase();
  renderGrid();
});

document.getElementById("importBtn").addEventListener("click", openImport);
document.getElementById("cancelBtn").addEventListener("click", closeModal);
document.getElementById("saveBtn").addEventListener("click", saveRecipe);

document.addEventListener("click", () => {
  const menu = document.getElementById("recipe-menu");
  if (menu) menu.classList.add("hidden");
});

/* ---------- Load ---------- */

async function loadRecipes() {
  const res = await fetch(`${API}/recipes`);
  allRecipes = await res.json();
  renderTags();
  renderGrid();
}

/* ---------- Tags ---------- */

function renderTags() {
  const set = new Set();
  allRecipes.forEach(r => (r.tags || []).forEach(t => set.add(t)));

  const ul = document.getElementById("tag-list");
  ul.innerHTML = "";

  const all = document.createElement("li");
  all.textContent = "All Recipes";
  all.onclick = () => { activeTag = null; renderGrid(); };
  ul.appendChild(all);

  [...set].sort().forEach(tag => {
    const li = document.createElement("li");
    li.textContent = tag;
    li.onclick = () => { activeTag = tag; renderGrid(); };
    ul.appendChild(li);
  });
}

/* ---------- Grid ---------- */

function recipeMatches(r) {
  if (activeTag && !(r.tags || []).includes(activeTag)) return false;
  if (!searchQuery) return true;

  return (
    r.name.toLowerCase().includes(searchQuery) ||
    (r.tags || []).join(" ").toLowerCase().includes(searchQuery)
  );
}

function renderGrid() {
  const view = document.getElementById("view");
  view.innerHTML = "";

  const grid = document.createElement("div");
  grid.className = "grid";

  allRecipes.filter(recipeMatches).forEach(r => {
    const card = document.createElement("div");
    card.className = "card";
    card.onclick = () => openRecipe(r.name);

    const img = document.createElement("div");
    img.className = "card-image";
    if (r.cover) {
      img.style.backgroundImage =
        `url('${API}/photos/${encodeURIComponent(r.name)}/${encodeURIComponent(r.cover)}')`;
    }

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = r.name;

    card.appendChild(img);
    card.appendChild(title);
    grid.appendChild(card);
  });

  view.appendChild(grid);
}

/* ---------- Recipe View ---------- */

async function openRecipe(name) {
  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  let md = await res.text();

  md = md
    .replace(/^Tags:.*\n+/im, "")
    .replace(/^#\s+.*$/gm, "");

  const html = marked.parse(md);
  const recipe = allRecipes.find(r => r.name === name);
  const tags = recipe?.tags?.join(", ") || "";

  const view = document.getElementById("view");

  view.innerHTML = `
    <div class="recipe-header">
      <button class="icon-btn" id="backBtn">←</button>

      <div class="recipe-header-main">
        <h1>${name}</h1>
        ${tags ? `<div class="recipe-meta">Tags: ${tags}</div>` : ""}
      </div>

      <div class="menu-wrapper">
        <button class="icon-btn" id="menuBtn">⋯</button>
        <div id="recipe-menu" class="menu hidden">
          <div data-action="edit" data-name="${name}">Edit</div>
          <div class="danger" data-action="delete" data-name="${name}">Delete</div>
        </div>
      </div>
    </div>

    <div class="recipe">${html}</div>
  `;

  document.getElementById("backBtn").onclick = loadRecipes;

  document.getElementById("menuBtn").onclick = e => {
    e.stopPropagation();
    document.getElementById("recipe-menu").classList.toggle("hidden");
  };

  document.querySelectorAll("#recipe-menu div").forEach(item => {
    item.onclick = e => {
      e.stopPropagation();
      const action = item.dataset.action;
      const recipeName = item.dataset.name;

      if (action === "edit") editRecipe(recipeName);
      if (action === "delete") deleteRecipe(recipeName);
    };
  });

  rewriteImages(name);
}

/* ---------- Delete ---------- */

async function deleteRecipe(name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

  const res = await fetch(
    `${API}/recipes/${encodeURIComponent(name)}`,
    { method: "DELETE" }
  );

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  loadRecipes();
}

/* ---------- Images ---------- */

function rewriteImages(recipe) {
  document.querySelectorAll(".recipe img").forEach(img => {
    const file = img.getAttribute("src").split("/").pop();
    img.src = `${API}/photos/${encodeURIComponent(recipe)}/${encodeURIComponent(file)}`;
  });
}

/* ---------- Modal ---------- */

function openImport() {
  modalTitle.textContent = "Import Recipe";
  recipeName.value = "";
  recipeTags.value = "";
  recipeMarkdown.value = "";
  photoInput.value = "";
  modal.classList.remove("hidden");
}

async function editRecipe(name) {
  modalTitle.textContent = "Edit Recipe";

  const res = await fetch(`${API}/recipes/${encodeURIComponent(name)}`);
  const md = await res.text();

  recipeName.value = name;
  recipeMarkdown.value = md.replace(/^Tags:.*\n+/m, "");

  const recipe = allRecipes.find(r => r.name === name);
  recipeTags.value = recipe?.tags.join(", ") || "";

  modal.classList.remove("hidden");
}

function closeModal() {
  modal.classList.add("hidden");
}

/* ---------- Save ---------- */

async function saveRecipe() {
  const name = recipeName.value.trim();
  const markdown = recipeMarkdown.value;
  const tags = recipeTags.value;
  const photo = photoInput.files[0];

  if (!name || !markdown) {
    alert("Name and markdown required");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("markdown", markdown);
  form.append("tags", tags);
  if (photo) form.append("photo", photo);

  const res = await fetch(`${API}/recipes`, {
    method: "POST",
    body: form
  });

  if (!res.ok) {
    alert("Save failed");
    return;
  }

  closeModal();
  loadRecipes();
}

loadRecipes();
</script>
</body>
</html>
